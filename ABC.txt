import pandas as pd

# Define a condition to ensure that the old record exists (i.e., none of the key _OLD columns are NaN)
old_record_exists = (
    merged_df["LIMIT_AMOUNT_OLD"].notna() &
    merged_df["DAYLIGHT_OD_LIMIT_OLD"].notna() &
    merged_df["AVAILABILITY_FLAG_OLD"].notna() &
    merged_df["LINE_CURRENCY_OLD"].notna()
)

# Define the condition to capture changes
changes_detected = (
    (merged_df["LIMIT_AMOUNT_NEW"] != merged_df["LIMIT_AMOUNT_OLD"]) |
    (merged_df["DAYLIGHT_OD_LIMIT_NEW"] != merged_df["DAYLIGHT_OD_LIMIT_OLD"]) |
    (merged_df["AVAILABILITY_FLAG_NEW"] != merged_df["AVAILABILITY_FLAG_OLD"]) |
    (merged_df["LINE_CURRENCY_NEW"] != merged_df["LINE_CURRENCY_OLD"])
)

# Combine the conditions
change_conditions = (
    (merged_df["RECORD_STAT_NEW"] == "0") &  # Only consider records with RECORD_STAT_NEW == "0"
    old_record_exists &                      # Exclude rows where old records are NaN
    changes_detected                         # Capture any changes between new and old values
)

# Apply the filter to get the changed lines
changed_lines = merged_df[change_conditions]
